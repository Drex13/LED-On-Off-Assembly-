    LIST    P=18F4550
    #include <xc.inc>

    CONFIG  FOSC = INTOSCIO_EC
    CONFIG  FCMEN = OFF
    CONFIG  IESO = OFF
    CONFIG  WDT = OFF
    CONFIG  PBADEN = OFF
    CONFIG  LVP = OFF

    PSECT   udata_acs
CONTADOR:   DS 1
TIEMPO1:    DS 1
TIEMPO2:    DS 1
TIEMPO3:    DS 1
SECUENCIA:  DS 1
TEMP:       DS 1
BOTON_ANT:  DS 1
PAUSA:      DS 1

    PSECT   resetVec,class=CODE,reloc=2
    GOTO    PROGRAMA_PRINCIPAL

    PSECT   code
PROGRAMA_PRINCIPAL:
    MOVLW   0x0F
    MOVWF   ADCON1, A
    MOVLW   0x07
    MOVWF   CMCON, A
    MOVLW   0xF0
    MOVWF   TRISB, A
    CLRF    LATB, A
    BCF     INTCON2,7
    MOVLW   0x72
    MOVWF   OSCCON, A
    CLRF    SECUENCIA, A
    MOVLW   1
    MOVWF   BOTON_ANT, A
    CLRF    PAUSA, A

BUCLE_PRINCIPAL:
    CALL    CHECK_BOTON_TOGGLE
    MOVF    SECUENCIA, W, A
    BZ      SECUENCIA_CARRERA
    XORLW   0x01
    BZ      SECUENCIA_PARPADEO
    BRA     SECUENCIA_BINARIO

SECUENCIA_CARRERA:
    MOVLW   0x01
    MOVWF   LATB, A
    CALL    ESPERAR
    CALL    ESPERA_PAUSA
    MOVLW   0x02
    MOVWF   LATB, A
    CALL    ESPERAR
    CALL    ESPERA_PAUSA
    MOVLW   0x04
    MOVWF   LATB, A
    CALL    ESPERAR
    CALL    ESPERA_PAUSA
    MOVLW   0x08
    MOVWF   LATB, A
    CALL    ESPERAR
    CALL    ESPERA_PAUSA
    CLRF    LATB, A
    CALL    ESPERAR
    CALL    ESPERA_PAUSA
    BRA     BUCLE_PRINCIPAL

SECUENCIA_PARPADEO:
    MOVLW   0x03
    MOVWF   CONTADOR, A
PARPADEO_LOOP:
    MOVLW   0x0F
    MOVWF   LATB, A
    CALL    ESPERAR_LARGO
    CALL    ESPERA_PAUSA
    CLRF    LATB, A
    CALL    ESPERAR_LARGO
    CALL    ESPERA_PAUSA
    DECFSZ  CONTADOR, F, A
    BRA     PARPADEO_LOOP
    BRA     BUCLE_PRINCIPAL

SECUENCIA_BINARIO:
    CLRF    CONTADOR, A
    MOVLW   0x10
    MOVWF   TEMP, A
BINARIO_LOOP:
    MOVF    CONTADOR, W, A
    MOVWF   LATB, A
    CALL    ESPERAR_LARGO
    CALL    ESPERA_PAUSA
    INCF    CONTADOR, F, A
    DECFSZ  TEMP, F, A
    BRA     BINARIO_LOOP
    BRA     BUCLE_PRINCIPAL

ESPERAR:
    MOVLW   0x20
    MOVWF   TIEMPO3, A
CICLO3:
    MOVLW   0xFF
    MOVWF   TIEMPO2, A
CICLO2:
    MOVLW   0xFF
    MOVWF   TIEMPO1, A
CICLO1:
    DECFSZ  TIEMPO1, F, A
    BRA     CICLO1
    DECFSZ  TIEMPO2, F, A
    BRA     CICLO2
    DECFSZ  TIEMPO3, F, A
    BRA     CICLO3
    RETURN

ESPERAR_LARGO:
    MOVLW   0x80
    MOVWF   TIEMPO3, A
CICLO3_LARGO:
    MOVLW   0xFF
    MOVWF   TIEMPO2, A
CICLO2_LARGO:
    MOVLW   0xFF
    MOVWF   TIEMPO1, A
CICLO1_LARGO:
    DECFSZ  TIEMPO1, F, A
    BRA     CICLO1_LARGO
    DECFSZ  TIEMPO2, F, A
    BRA     CICLO2_LARGO
    DECFSZ  TIEMPO3, F, A
    BRA     CICLO3_LARGO
    RETURN

CHECK_BOTON_TOGGLE:
    BTFSC   PORTB,4, A
    GOTO    BTN_SUELTO1
    CLRF    TEMP, A
    GOTO    BTN_MUESTRA1
BTN_SUELTO1:
    MOVLW   1
    MOVWF   TEMP, A
BTN_MUESTRA1:
    MOVF    TEMP, W, A
    XORWF   BOTON_ANT, W, A
    BZ      CBT_END
    CALL    DEBOUNCE_20MS
    BTFSC   PORTB,4, A
    GOTO    BTN_SUELTO2
    CLRF    TEMP, A
    GOTO    BTN_MUESTRA2
BTN_SUELTO2:
    MOVLW   1
    MOVWF   TEMP, A
BTN_MUESTRA2:
    MOVF    TEMP, W, A
    MOVWF   BOTON_ANT, A
    MOVF    TEMP, W, A
    BNZ     CBT_END
    MOVLW   1
    XORWF   PAUSA, F, A
    INCF    SECUENCIA, F, A
    MOVLW   3
    CPFSLT  SECUENCIA, A
    BRA     CBT_END
    CLRF    SECUENCIA, A
CBT_END:
    RETURN

ESPERA_PAUSA:
    MOVF    PAUSA, W, A
    BZ      EP_EXIT
EP_LOOP:
    CALL    CHECK_BOTON_TOGGLE
    MOVF    PAUSA, W, A
    BNZ     EP_LOOP
EP_EXIT:
    RETURN

DEBOUNCE_20MS:
    MOVLW   20
    MOVWF   CONTADOR, A
DB_L:
    NOP
    NOP
    DECFSZ  CONTADOR, F, A
    BRA     DB_L
    RETURN

    END
